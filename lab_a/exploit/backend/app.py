from flask import Flask, request, jsonify
from flask_cors import CORS
import sqlite3
import os

app = Flask(__name__)
CORS(app, resources={
    r"/api/*": {
        "origins": "*",
        "methods": ["GET", "POST", "OPTIONS"],
        "allow_headers": ["Content-Type"]
    }
})

DATABASE = 'users.db'

def get_db_connection():
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT NOT NULL UNIQUE,
            password TEXT NOT NULL
        )
    ''')

    sample_users = [
        ('Alice Johnson', 'alice@example.com', 'password123'),
        ('Bob Smith', 'bob@example.com', 'securepass456'),
        ('Charlie Brown', 'charlie@example.com', 'mypassword789'),
        ('Admin User', 'admin@example.com', 'admin_secret_password'),
        ('David Wilson', 'david@example.com', 'david2024'),
    ]

    try:
        cursor.executemany(
            'INSERT INTO users (name, email, password) VALUES (?, ?, ?)',
            sample_users
        )
        conn.commit()
    except sqlite3.IntegrityError:
        pass

    conn.close()

@app.route('/api/login', methods=['POST'])
def login():
    data = request.get_json()
    username = data.get('username', '')
    password = data.get('password', '')

    query = f"SELECT id, name, email FROM users WHERE email = '{username}' AND password = '{password}'"

    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute(query)
        result = cursor.fetchone()

        if result:
            user = {
                'id': result['id'],
                'name': result['name'],
                'email': result['email']
            }

            conn.close()

            return jsonify({
                'success': True,
                'message': 'Login successful!',
                'user': user,
                'query': query
            })
        else:
            conn.close()

            return jsonify({
                'success': False,
                'message': 'Invalid username or password',
                'query': query
            }), 401

    except Exception as e:
        conn.close()
        return jsonify({
            'success': False,
            'error': str(e),
            'query': query
        }), 500

if __name__ == '__main__':
    if not os.path.exists(DATABASE):
        print("Initializing database...")
        init_db()
        print("Database initialized with sample data!")

    app.run(host='0.0.0.0', port=5001, debug=True)
